name: Mod Build

on:
  workflow_dispatch:
    inputs:
      branches:
        description: 'Branches to build (comma-separated, e.g., main,1.20.1,1.21.4)'
        required: true
        default: 'main'
        type: string

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Set matrix
        id: set-matrix
        run: |
          # Convert comma-separated branches to JSON array
          branches="${{ github.event.inputs.branches }}"
          echo "Input branches: $branches"
          
          # Remove spaces
          branches_clean=$(echo "$branches" | tr -d ' ')
          
          # Convert to JSON array using Python (more reliable)
          json_array=$(python3 -c "
          import json
          import sys
          branches = '$branches_clean'.split(',')
          branches = [b.strip() for b in branches if b.strip()]
          print(json.dumps(branches))
          ")
          
          echo "matrix=$json_array" >> $GITHUB_OUTPUT
          echo "Generated matrix: $json_array"

  build:
    needs: prepare
    runs-on: ubuntu-latest
    strategy:
      matrix:
        branch: ${{ fromJson(needs.prepare.outputs.matrix) }}
      fail-fast: false

    steps:
      - name: Checkout specific branch
        uses: actions/checkout@v4
        with:
          ref: ${{ matrix.branch }}
          fetch-depth: 0

      - name: Verify branch checkout
        run: |
          echo "Current branch: $(git branch --show-current)"
          echo "Current commit: $(git rev-parse HEAD)"
          echo "Expected branch: ${{ matrix.branch }}"

      - name: Build
        uses: xxanqw/compilation@v2

      - name: Archive built .jar
        uses: actions/upload-artifact@v4
        with:
          name: Build-${{ matrix.branch }}
          path: ./build/libs